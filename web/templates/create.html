{% extends '_base.html' %}
{% load static %}

{% block title %}
    Create
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/create.css' %}">
{% endblock %}

{% block topbar_right %}{% endblock %}

{% block body %}

    <section class="mode-switch container">
        <div class="tabs">
            <button class="tab active" data-mode="txt2img">üìù Text ‚Üí Bild</button>
            <button class="tab" data-mode="img2img">üñºÔ∏è Bild ‚Üí Bild</button>
            <button class="tab" data-mode="upscale">üîç Upscale</button>
        </div>
    </section>

    <main class="container" id="app">
        <main class="container" id="app">
            <div class="grid">

                <!-- SECTION TXT2IMG -->
                <section class="card" data-section="txt2img">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Eingabe</div>
                            <div class="card-sub">Prompt, Modelle & Parameter</div>
                        </div>
                        <button class="icon-btn secondary" id="resetBtn">Zur√ºcksetzen</button>
                    </div>
                    <div class="card-body row">
                        <div class="row">
                            <label class="label" for="prompt">Prompt</label>
                            <textarea id="prompt" class="textarea"
                                      placeholder="z.B. ultra-detailed portrait of a cyberpunk cat, neon lights, 85mm"
                                      spellcheck="false"
                                      data-section-element="prompt"
                            ></textarea>
                            <div class="pills" id="promptPills">
                                <span class="pill" data-insert=","
                                      data-text="dramatic lighting">dramatic lighting</span>
                                <span class="pill" data-insert="," data-text="highly detailed">highly detailed</span>
                                <span class="pill" data-insert="," data-text="8k uhd">8k uhd</span>
                            </div>
                        </div>

                        <div class="row">
                            <label class="label" for="neg">Negativer Prompt</label>
                            <textarea id="neg" class="textarea"
                                      placeholder="z.B. lowres, blurry, extra limbs, watermark"
                                      spellcheck="false"
                                      data-section-element="neg"></textarea>
                        </div>

                        <div class="grid-2">
                            <div class="row">
                                <label class="label" for="model">Modell</label>
                                <select id="model" class="select" data-section-element="model">
                                    {% for model in models %}
                                        <option value="{{ model.hgf_name }}">{{ model.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="row">
                                <label class="label" for="sampler">Sampler</label>
                                <select id="sampler" class="select" data-section-element="sampler">
                                    <option>Euler a</option>
                                    <option>DDIM</option>
                                    <option>DPM++ 2M</option>
                                    <option>UniPC</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-3">
                            <div class="row">
                                <div class="label">Schritte <span id="stepsVal" class="card-sub"></span></div>
                                <div class="range-wrap"><input id="steps" class="range" type="range" min="1" max="120"
                                                               value="30" data-section-element="steps"><span
                                        class="bubble"
                                        aria-hidden="true">30</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="label">CFG <span id="cfgVal" class="card-sub"></span></div>
                                <div class="range-wrap"><input id="cfg" class="range" type="range" min="1" max="20"
                                                               value="7" data-section-element="cfg"><span class="bubble"
                                                                                                          aria-hidden="true">7</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="label">Seed <span id="seedVal" class="card-sub"></span></div>
                                <input id="seed" class="input" type="number" placeholder="-1 = zuf√§llig" value="-1"
                                       data-section-element="seed"/>
                            </div>
                        </div>

                        <div class="grid-3">
                            <div class="row">
                                <label class="label">Breite</label>
                                <input id="width" class="input" type="number" value="512" data-section-element="width"/>
                            </div>
                            <div class="row">
                                <label class="label">H√∂he</label>
                                <input id="height" class="input" type="number" value="512"
                                       data-section-element="height"/>
                            </div>
                            <div class="row">
                                <label class="label">Upscaler</label>
                                <select id="upscaler" class="select" data-section-element="upscaler">
                                    <option>Keiner</option>
                                    <option>4x-UltraSharp</option>
                                    <option>ESRGAN</option>
                                </select>
                            </div>
                        </div>

                        <details>
                            <summary class="label" style="cursor:pointer">Erweitert</summary>
                            <div class="row" style="margin-top:12px">
                                <div class="grid-2">
                                    <label class="input" style="display:flex;align-items:center;gap:10px"><input
                                            type="checkbox" id="tiling" data-section-element="tiling"> Tiling</label>
                                    <label class="input" style="display:flex;align-items:center;gap:10px"><input
                                            type="checkbox" id="hiresfix" data-section-element="hiresfix" checked> Hires
                                        Fix</label>
                                </div>
                                <div class="grid-2">
                                    <div class="row">
                                        <label class="label">Guidance (Refiner)</label>
                                        <div class="range-wrap"><input id="refiner" class="range" type="range" min="0"
                                                                       max="1" step="0.05" value="0.2"
                                                                       data-section-element="refiner"><span
                                                class="bubble">0.2</span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <label class="label">ETA / Noise</label>
                                        <div class="range-wrap"><input id="eta" class="range" type="range" min="0"
                                                                       max="1"
                                                                       step="0.01" value="0.0"
                                                                       data-section-element="eta"><span
                                                class="bubble">0.00</span></div>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <div class="toolbar">
                            <button class="btn generateBtn" id="generateBtn">‚ö° Generieren</button>
                            <button class="btn secondary" id="queueBtn">‚ûï Warteschlange</button>
                            <button class="btn secondary" id="randomizeBtn">üé≤ Zuf√§lliger Seed</button>
                        </div>

                        <div class="row">
                            <div class="label">Fortschritt<span class="progressLabel"></span></div>
                            <div class="progress" aria-live="polite" aria-label="Fortschrittsanzeige"><span
                                    class="progressBar"></span></div>
                        </div>
                    </div>
                </section>

                <!-- SECTION IMG2IMG -->
                <section class="card" data-section="img2img" style="display:none">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Bild ‚Üí Bild</div>
                            <div class="card-sub">Upload & Transformation</div>
                        </div>
                    </div>
                    <div class="card-body row">
                        <div class="row">
                            <div class="label">Bild-zu-Bild</div>
                            <div class="dropzone" id="dropzone" data-section-element="dropzone">
                                <input type="file" accept="image/*" hidden/>
                                <p><strong>Datei hierher ziehen</strong> oder klicken zum Ausw√§hlen</p>
                                <p class="card-sub">St√§rke <span id="strengthValue">0.5</span></p>
                                <div class="range-wrap" style="margin-top:8px;max-width:420px;margin-inline:auto"><input
                                        id="strength" class="range" type="range" min="0" max="1" step="0.01"
                                        value="0.5" data-section-element="strength"><span class="bubble">0.50</span>
                                </div>
                                <div class="preview hidden" style="margin-top:12px"></div>
                            </div>
                        </div>
                        <div class="toolbar">
                            <button class="btn generateBtn" id="img2imgGenerate">‚ö° Generieren</button>
                            <button class="btn secondary" id="queueBtn">‚ûï Warteschlange</button>
                        </div>
                        <div class="row">
                            <div class="label">Fortschritt<span class="progressLabel"></span></div>
                            <div class="progress" aria-live="polite" aria-label="Fortschrittsanzeige"><span
                                    class="progressBar"></span></div>
                        </div>
                    </div>
                </section>

                <!-- SECTION UPSCALE -->
                <section class="card" data-section="upscale" style="display:none">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Upscaler</div>
                            <div class="card-sub">Bild vergr√∂√üern & sch√§rfen</div>
                        </div>
                    </div>
                    <div class="card-body row">
                        <div class="row">
                            <div class="label">Bild</div>
                            <div class="dropzone" id="dropzone" data-section-element="dropzone">
                                <input type="file" accept="image/*" hidden/>
                                <p><strong>Datei hierher ziehen</strong> oder klicken zum Ausw√§hlen</p>
                                <div class="preview hidden" style="margin-top:12px"></div>
                            </div>
                        </div>
                        <div class="row">
                            <label class="label">Upscaler ausw√§hlen</label>
                            <select id="upscaler" class="select" data-section-element="upscaler">
                                <option>4x-UltraSharp</option>
                                <option>ESRGAN</option>
                            </select>
                        </div>

                        <div class="row">
                            <label class="label" for="prompt">Prompt</label>
                            <textarea id="prompt" class="textarea"
                                      placeholder="z.B. ultra-detailed portrait of a cyberpunk cat, neon lights, 85mm"
                                      spellcheck="false" data-section-element="prompt"></textarea>
                        </div>

                        <div class="row">
                            <label class="label" for="neg">Negativer Prompt</label>
                            <textarea id="neg" class="textarea"
                                      placeholder="z.B. lowres, blurry, extra limbs, watermark"
                                      spellcheck="false" data-section-element="neg"></textarea>
                        </div>


                        <div class="toolbar">
                            <button class="btn generateBtn" id="upscaleGenerate">üîç Upscale</button>
                            <button class="btn secondary" id="queueBtn">‚ûï Warteschlange</button>
                        </div>

                        <div class="row">
                            <div class="label">Fortschritt<span class="progressLabel"></span></div>
                            <div class="progress" aria-live="polite" aria-label="Fortschrittsanzeige"><span
                                    class="progressBar"></span></div>
                        </div>
                    </div>
                </section>


                <!-- RIGHT: Output -->
                <section class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Ergebnisse</div>
                            <div class="card-sub">Galerie, Verlauf & Aktionen</div>
                        </div>
                        <div class="toolbar">
                            <button class="icon-btn" id="saveAll">Alle speichern</button>
                            <button class="icon-btn" id="clearGallery">Leeren</button>
                        </div>
                    </div>
                    <div class="card-body row">
                        <div id="gallery" class="gallery" aria-live="polite"></div>
                        <div class="footer">
                            <strong>Made with ‚ô•Ô∏è by Philipp Schott</strong>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </main>

    <div class="toast" id="toast"></div>


    <script>
        // --- Mode Switch ---
        const tabs = document.querySelectorAll('.tab');
        let currentMode = "txt2img";
        let currentTab = undefined;
        document.querySelectorAll('[data-section]').forEach(sec => {
            if (sec.dataset.section === currentMode) {
                currentTab = sec;
            }
        });
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentMode = tab.dataset.mode;

                document.querySelectorAll('[data-section]').forEach(sec => {
                    sec.style.display = (sec.dataset.section === currentMode) ? 'block' : 'none';
                    if (sec.dataset.section === currentMode) {
                        currentTab = sec;
                    }
                });

                showToast("Mode: " + tab.textContent.trim());
            });
        });
    </script>

    <script>
        let socketConnected = false;
        let socket = undefined;
        const createWebSocket = () => {
            socket = new WebSocket('ws://' + location.host + '/ws/create/');
            socket.onopen = () => {
                socketConnected = true;
                showToast('Verbunden!');
            }
            socket.onmessage = (e) => {
                const payload = JSON.parse(e.data);
                const event = payload.event;
                const data = payload.data;

                if (event === "creation-finished") {
                    document.getElementById('generation-preview').remove();
                    addToGallery(data);

                    for (let i = 0; i < generateBtns.length; i++) {
                        generateBtns[i].disabled = false;
                        generateBtns[i].textContent = '‚ö° Generieren';
                    }
                    for (let i = 0; i < progressLabels.length; i++) {
                        progressLabels[i].innerText = "";
                    }
                } else if (event === "progress") {
                    const steps = data["steps"];
                    const step = data["step"];
                    const pct = data["percent"];

                    updateProgressBar(steps, step, pct, ` (${step} / ${steps}) ETA: ${data["eta"]}`);

                    previewGenerationState(data["img_state"]);

                    if (!isCurrentlyGenerating()) {
                        for (let i = 0; i < generateBtns.length; i++) {
                            generateBtns[i].disabled = true;
                            generateBtns[i].textContent = '‚è≥ Generiere...';
                        }
                    }
                } else if (event === "progress-upscaler") {
                    const steps = data["steps"];
                    const step = data["step"];
                    const pct = data["percent"];
                    updateProgressBar(steps, step, pct, ` (${step} / ${steps}) ETA: ${data["eta"]} - Upscaling`);

                    previewGenerationState(data["img_state"]);

                    if (!isCurrentlyGenerating()) {
                        for (let i = 0; i < generateBtns.length; i++) {
                            generateBtns[i].disabled = true;
                            generateBtns[i].textContent = '‚è≥ Generiere...';
                        }
                    }
                } else {
                    console.log(event)
                }
            }
            socket.onclose = () => {
                socketConnected = false;
                showToast('Verbindung verloren..');
                setTimeout(createWebSocket, 1000);
            }
        }
        const sendSocketMessage = (event = '', json_data = {}) => {
            if (socket === undefined || !socketConnected) {
                showToast("Nicht Verbunden..");
                return false;
            }
            socket.send(JSON.stringify({
                'event': event,
                'data': json_data
            }));
            return true;
        }
        createWebSocket();
    </script>

    <script>
        // --- UI Helpers ---
        function attachRange(id) {
            const el = document.getElementById(id);
            const bubble = el.parentElement.querySelector('.bubble');
            const out = document.getElementById(id + 'Val');
            const update = () => {
                bubble.textContent = el.value;
                if (out) out.textContent = '(' + el.value + ')';
                positionBubble();
            };
            const positionBubble = () => {
                const val = (el.value - el.min) / (el.max - el.min);
                const offset = el.offsetWidth * val;
                bubble.style.left = offset + 'px';
            }
            el.addEventListener('input', update);
            window.addEventListener('resize', () => requestAnimationFrame(positionBubble));
            update();
        }

        ['steps', 'cfg', 'refiner', 'eta', 'strength'].forEach(attachRange);

        // --- Prompt Pills ---
        document.getElementById('promptPills').addEventListener('click', (e) => {
            const t = e.target.closest('.pill');
            if (!t) return;
            const insert = t.dataset.insert || ', ';
            const text = t.dataset.text || t.textContent.trim();
            const ta = document.getElementById('prompt');
            ta.value = (ta.value ? ta.value + insert : '') + text;
            ta.focus();
        });

        // --- Dropzone ---
        const dzs = document.getElementsByClassName('dropzone');
        for (let i = 0; i < dzs.length; i++) {
            const dz = dzs[i];
            const preview = dz.getElementsByClassName('preview')[0];

            const fileInput = dz.getElementsByTagName('input')[0];
            fileInput.addEventListener('change', (e) => {
                const f = e.target.files[0];
                if (f) handleFile(f, fileInput, preview);
            });


            dz.addEventListener('click', () => fileInput.click());
            dz.addEventListener('dragover', (e) => {
                e.preventDefault();
                dz.classList.add('dragover');
            });
            dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
            dz.addEventListener('drop', (e) => {
                e.preventDefault();
                dz.classList.remove('dragover');
                const f = e.dataTransfer.files[0];
                if (f) handleFile(f, fileInput, preview);
            });
        }

        function handleFile(file, fileInput, preview) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `<img src="${e.target.result}" alt="Vorlage"><div><div class="card-sub">${file.name} ‚Ä¢ ${(file.size / 1024 / 1024).toFixed(2)} MB</div></div>`;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function getBase64ImageData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    return resolve(e.target.result);
                };
                reader.readAsDataURL(file);
            })
        }

        // --- Toast ---
        const toast = document.getElementById('toast');

        let toastTimeout = undefined;
        function showToast(msg, timeout = 2200) {
            if(toastTimeout) clearTimeout(toastTimeout);
            toast.textContent = msg;
            toast.style.display = 'block';
            toastTimeout = setTimeout(() => {
                toast.style.display = 'none';
                toastTimeout = undefined;
            }, timeout);
        }

        // --- Buttons ---
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('prompt').value = '';
            document.getElementById('neg').value = '';
            document.getElementById('steps').value = 30;
            document.getElementById('cfg').value = 7;
            ['steps', 'cfg'].forEach(attachRange);
            document.getElementById('seed').value = -1;
            document.getElementById('width').value = 512;
            document.getElementById('height').value = 512;
            document.getElementById('upscaler').selectedIndex = 0;
            document.getElementById('sampler').selectedIndex = 0;
            document.getElementById('model').selectedIndex = 0;
            showToast('Zur√ºckgesetzt');
        });

        document.getElementById('randomizeBtn').addEventListener('click', () => {
            const s = Math.floor(Math.random() * 1e9);
            document.getElementById('seed').value = s;
            showToast('Seed: ' + s);
        });

        // --- Keyboard Shortcut ---
        /*
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generate();
        });
        */

        const progressBars = document.getElementsByClassName('progressBar');
        const progressLabels = document.getElementsByClassName('progressLabel');
        const generateBtns = document.getElementsByClassName('generateBtn');
        for (let i = 0; i < generateBtns.length; i++) {
            generateBtns[i].addEventListener('click', generate);
        }
        document.getElementById('queueBtn').addEventListener('click', () => {
            generate();
        });

        const updateProgressBar = (steps, step, pct, text) => {

            for (let i = 0; i < progressBars.length; i++) {
                progressBars[i].style.width = pct + '%';
            }
            for (let i = 0; i < progressLabels.length; i++) {
                progressLabels[i].innerText = text;
            }
        }

        const isCurrentlyGenerating = () => {
            for (let i = 0; i < generateBtns.length; i++) {
                if(generateBtns[i].disabled) return true;
            }
            return false;
        }

        async function generate() {
            let payload = await collectPayload();
            if(payload === null) {
                showToast("Bitte f√ºge ein Bild hinzu")
                return;
            }
            let isGenerating = isCurrentlyGenerating();
            for (let i = 0; i < generateBtns.length; i++) {
                generateBtns[i].disabled = true;
                generateBtns[i].textContent = '‚è≥ Generiere...';
            }

            let img = payload.img;
            payload.img = undefined;
            let payload_final = {
                'event_type': currentMode,
                'settings': payload,
                'img': img,
            }
            let sent = sendSocketMessage('create', payload_final);

            if (!sent) {
                for (let i = 0; i < generateBtns.length; i++) {
                    generateBtns[i].disabled = false;
                    generateBtns[i].textContent = '‚ö° Generieren';
                }
            }
            if(isGenerating && sent) showToast('Zur Warteschlange hinzugef√ºgt');
        }

        // --- Gallery ---
        const gallery = document.getElementById('gallery');

        const addToGallery = (base64Image) => {
            const imageSrc = 'data:image/png;base64,' + base64Image;

            const el = document.createElement('div');
            el.className = 'thumb';
            el.innerHTML = `
                <img src="${imageSrc}" alt="Generiertes Bild" loading="lazy"/>
                <div class="meta">
                <span>${document.getElementById('model').value.toUpperCase()}</span>
                <div class="toolbar">
                    <button class="pill" title="Als Prompt √ºbernehmen">üìã</button>
                    <button class="pill" title="Download">‚¨áÔ∏è</button>
                </div>
                </div>`;
            gallery.prepend(el);
        }

        const previewGenerationState = (base64Image) => {
            const imageSrc = 'data:image/png;base64,' + base64Image;

            let el = document.getElementById('generation-preview');
            if (el === null) {
                el = document.createElement('div');
                el.id = 'generation-preview';
                el.className = 'thumb';
                el.innerHTML = `
                    <img src="${imageSrc}" alt="Generiertes Bild" loading="lazy"/>
                `;
            } else {
                el.getElementsByTagName('img')[0].src = imageSrc;
            }
            if (!gallery.contains(el)) gallery.prepend(el);

        }

        document.getElementById('clearGallery').addEventListener('click', () => {
            gallery.innerHTML = '';
            showToast('Gallery cleared!');
        });
        document.getElementById('saveAll').addEventListener('click', () => showToast('Bitte im Backend implementieren: ZIP-Export'));

        async function collectPayload() {
            let elements = Array.from(currentTab.querySelectorAll('[data-section-element]'));
            const getElementById = (id) => {
                let found = elements.filter(item => item.id === id);
                if (found.length > 0) return found[0];
                return undefined;
            }
            let file = undefined;
            switch (currentMode) {
                case 'txt2img':
                    return {
                        prompt: getElementById('prompt').value,
                        negative: getElementById('neg').value,
                        model: getElementById('model').value,
                        sampler: getElementById('sampler').value,
                        steps: Number(getElementById('steps').value),
                        cfg: Number(getElementById('cfg').value),
                        seed: Number(getElementById('seed').value),
                        width: Number(getElementById('width').value),
                        height: Number(getElementById('height').value),
                        upscaler: getElementById('upscaler').value,
                        tiling: getElementById('tiling').checked,
                        hiresfix: getElementById('hiresfix').checked,
                        refiner: Number(getElementById('refiner').value),
                        eta: Number(getElementById('eta').value),
                    };
                case 'img2img':
                    file = getElementById('dropzone').getElementsByTagName('img')[0].src.replace("data:image/png;base64,", "");
                    return {
                        img: file,
                        strength: Number(getElementById('strength').value),
                    };
                case 'upscale':
                    file = getElementById('dropzone').getElementsByTagName('img')[0].src.replace("data:image/png;base64,", "");
                    return {
                        img: file,
                        upscaler: getElementById('upscaler').value,
                        prompt: getElementById('prompt').value,
                        negative: getElementById('neg').value,
                    };
            }
        }
    </script>
{% endblock %}